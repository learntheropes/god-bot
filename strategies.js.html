<script>
          
  // modificare per uso con html (icone ecc)
  function makeDropdown(choices_array, action){
    
    var field = document.createElement('div');
    field.classList.add('field');
    
    var dropdown_content = document.createElement('div');
    dropdown_content.classList.add('dropdown-content')
    
    choices_array.forEach(function(el) {
          
      var a = document.createElement('a');
      if (this.action) a.setAttribute('onclick', this.action);
      a.setAttribute('value', el);
      a.classList.add('dropdown-item');
      a.innerText = el;
      
      this.content.appendChild(a);
    }, {content: dropdown_content, action: action});
                
    var dropdown = document.createElement('div');
    dropdown.classList.add('dropdown');
    dropdown.classList.add('is-up');
    
    var dropdown_trigger = document.createElement('div');
    dropdown_trigger.classList.add('dropdown-trigger');
    
    var button = document.createElement('button');
    button.classList.add('button');
    button.setAttribute('id','foobar');
    button.setAttribute('aria-haspopup','true');
    button.setAttribute('aria-controls','dropdown-menu');
    
    var dropdown_menu = document.createElement('div');
    dropdown_menu.classList.add('dropdown-menu');
    dropdown_menu.setAttribute('id','dropdown-menu');
    dropdown_menu.setAttribute('role', 'menu');
    
    var txt = document.createElement('span');
    txt.innerText = 'Indicators';
        
    var i = document.createElement('i');
    i.classList.add('fas');
    i.classList.add('fa-angle-up');
    i.setAttribute('aria-hidden', 'true');
    
    var icon = document.createElement('span');
    icon.classList.add('icon');
    icon.classList.add('is-small');
    
    icon.appendChild(i);
    button.appendChild(txt);
    button.appendChild(icon);
    dropdown_trigger.appendChild(button);
    dropdown_menu.appendChild(dropdown_content);
    dropdown.appendChild(dropdown_trigger);
    dropdown.appendChild(dropdown_menu);
    field.appendChild(dropdown)
    return field;
  };
  
// END FORM LIBRARY
  
  app = {};
  
  app.user = {
    timeframes: [],
    indicators: [],
    conditions: [],
    actions: []
  }
  
  app.default = {
    timeframes: ['15m','30m','1h','2h','4h','1d','7d'],
    indicators: {
      BOLL: {periods: 20,sdn: 2},
      CCI: {periods: 26},
      DMA: {fastperiod: 10,slowperiod: 50},
      DMI: {periods: 14},
      SMA: {periods: 30},
      EMA: {periods: 30},
      MACD: {fastperiod: 12,slowperiod: 26,signalperiod: 9},
      MTM: {periods: 9},
      OBV : {},
      ROC: {periods: 12},
      RSI: {periods: 14},
      TRIX: {periods: 12}
    }
  }

   /* 
  window.onload = function() {
    const button = document.querySelector('.button');
    const dropdown = document.querySelector('.dropdown');
    button.onclick = function(){
      dropdown.classList.toggle('is-active');
    };
   
  };
 */
 
 
 
  function toggleIndicatorsList() {
    var target = document.getElementById('newIndicator');
    var icon = document.getElementById('toggle-up-down-1');
    if (target.hasChildNodes()) {
      while (target.firstChild) {
        target.removeChild(target.firstChild);
      }
      icon.classList.add('fas');
      icon.classList.add('fa-angle-down');
    } else {
      var keys = Object.keys(app.default.indicators);
      var el = dom_lib.buttonsList.make(keys, [], null, null, {onclick: 'appendIndicatorForm(this.getAttribute("value"))', type: 'submit'}, ['is-fullwidth'])
      target.appendChild(el);
      icon.classList.add('fas');
      icon.classList.add('fa-angle-up');
    }
  };
    
  function makeIndicatorForm(indicator_name, obj, action) {
  
    var field = document.createElement('div');
    field.setAttribute('name', 'IndicatorForm')
    field.classList.add('field');
    field.classList.add('is-horizontal');
    if (action) field.setAttribute('onchange', action);
    
    var field_label = dom_lib.label.make(indicator_name, 1);
    field.appendChild(field_label);
    
    var field_body = document.createElement('div');
    field_body.classList.add('field-body');
    
    var timeframes = dom_lib.select.make('Timeframe', app.default.timeframes, {size: 1})
    field_body.appendChild(timeframes);
    
    Object.keys(obj[indicator_name]).forEach(function(key) {
    
       var has_addons = document.createElement('div');
       has_addons.classList.add('field');
       has_addons.classList.add('has-addons');
       
       var control_pre = document.createElement('p');
       control_pre.classList.add('control');
       
       var pre = document.createElement('a');
       pre.classList.add('button');
       pre.classList.add('is-static');
       pre.innerText = key;
      
       var control_input = document.createElement('p');
       control_input.classList.add('control');
       
       var input = document.createElement('input');
       input.classList.add('input');
       input.setAttribute('type', 'text');
       input.setAttribute('placeholder', this.obj[this.indicator_name][key]);
      
       control_pre.appendChild(pre);
       control_input.appendChild(input);
       
       has_addons.appendChild(control_pre);
       has_addons.appendChild(control_input);
       this.field_body.appendChild(has_addons);
       
    }, {
         field_body: field_body,
         indicator_name: indicator_name,
         obj: obj
       }
    );
    // button_text, icon_name, attributes, classes
    var delete_button = dom_lib.button.make(null, 'far fa-trash-alt', {onclick: 'deleteMe(this)'}, ['is-1']);
    field_body.appendChild(delete_button);
 
    field.appendChild(field_body);
    return field;
  }
  
  function appendIndicatorForm(input) {
    var indicator_form = makeIndicatorForm(input, app.default.indicators, 'indicatorActions()');
    dom_lib.appendElement('indicators', indicator_form);
  };
  
  function indicatorActions() {

    var settings = Array.prototype.slice.call(document.getElementById('indicators').querySelectorAll('div[name="IndicatorForm"]')).map(function(node) {
      var indicator = Array.prototype.slice.call(node.querySelectorAll('label'),0).map(function(a) { return a.outerText})
      var keys = Array.prototype.slice.call(node.querySelectorAll('a'),0).map(function(a) { return a.outerText})
      var values = Array.prototype.slice.call(node.querySelectorAll('input'),0).map(function(a) { return a.value || a.placeholder })
      var timeframe = dom_lib.select.getSelected(node.querySelectorAll("option"))[0].value
      return {indicator: indicator, keys: keys, values: values, timeframe: timeframe};
    })
    
    function onlyUnique(value, index, self) {
      return (self.indexOf(value) === index && value !== 'Timeframe');
    }

    app.user.timeframes = app.default.timeframes.filter(function(tf) {
      return this.unique.indexOf(tf) > -1;
    }, {unique: settings.map(function(tf) { return tf.timeframe; }).filter(onlyUnique)});
    
    app.user.indicators = settings.map(function(s) {return s.indicator + '(' + s.values.join(',') + ').' + s.timeframe});
  }
  
  function makeConditionForm() {
    
    var ohlcv = app.user.timeframes.map(function(tf) {
      return ['open', 'close', 'high', 'low', 'volume'].map(function(el) {
        return 'OHLCV(' + el + ').' + tf;
      });
    }).flat();
    var all_indicators = app.user.indicators.concat(ohlcv);
    var left = dom_lib.select.make('Indicator', all_indicators, {size: 1});
    var operator = dom_lib.select.make('Operator',['>','>=','=','<=','<'], {size: 1});
    var right = dom_lib.select.make('Indicator', all_indicators.concat(['Fix Value']), {size: 1});
    
    var moltiplicator = document.createElement('input');
    moltiplicator.classList.add('input');
    moltiplicator.setAttribute('type', 'text');
    moltiplicator.setAttribute('placeholder', 1);
    
    var cond_name = document.createElement('input');
    cond_name.classList.add('input');
    cond_name.setAttribute('type', 'text');
    cond_name.setAttribute('placeholder', 'Name');
    
    var fields = [left, operator, right, moltiplicator, cond_name];
    
    var field = document.createElement('div');
    field.classList.add('field');
    field.classList.add('is-horizontal');
    field.setAttribute('name', 'conditionForm');
    // field.setAttribute('onchange', action);
    
    var field_body = document.createElement('div');
    field_body.classList.add('field-body');
    
    fields.forEach(function(f) {
    
       var field = document.createElement('div');
       field.classList.add('field');
       field.appendChild(f);
       this.field_body.appendChild(field);
       
    }, {field_body: field_body, indicatorsDefault: app.default.indicators})
    
    field.appendChild(field_body);
    return field;
  
  }
  
  function appendConditionForm() {
    var condition_form = makeConditionForm();
    dom_lib.appendElement('conditions', condition_form);
  }
  

  
  function deleteMe(e) {
    e.parentNode.parentNode.parentNode.removeChild(e.parentNode.parentNode);
  }
</script>