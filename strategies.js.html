<script>
  
  app = {};
  
  app.user = {
    timeframes: [],
    indicators: [],
    conditions: [],
    actions: []
  }
  
  app.default = {
    timeframes: ['15m','30m','1h','2h','4h','1d','7d'],
    indicators: {
      BOLL: {periods: 20,sdn: 2},
      CCI: {periods: 26},
      DMA: {fast: 10,slow: 50},
      DMI: {periods: 14},
      SMA: {periods: 30},
      EMA: {periods: 30},
      MACD: {fast: 12,slow: 26,signal: 9},
      MTM: {periods: 9},
      OBV : {},
      ROC: {periods: 12},
      RSI: {periods: 14},
      TRIX: {periods: 12}
    }
  }

   /* 
  window.onload = function() {
    const button = document.querySelector('.button');
    const dropdown = document.querySelector('.dropdown');
    button.onclick = function(){
      dropdown.classList.toggle('is-active');
    };
   
  };
 */
 
function toggleIndicatorsList() {
  
  var icon = document.getElementById('plus-minus-indicators');
  bulma_lib.icon.toggle(icon, 'fa-minus', 'fa-plus');
    
  var target = document.getElementById('indicators-list');
  if (target.hasChildNodes()) {
    
    while (target.firstChild) {
      target.removeChild(target.firstChild);
    }

  } else {
    var keys = Object.keys(app.default.indicators);
    var button_attributes = {type: 'submit',onclick: 'appendIndicatorForm(this)'};
    var el = bulma_lib.buttonsList.make(keys,null,null,{},[],button_attributes,['is-fullwidth'])
    target.appendChild(el);
  }
};
  
  
///INDICATOR FORM///
function newIndicatorForm(text) {

  // indicator_name
  var conditions_components = [bulma_lib.label.makeStandalone(text,'is-1',{},['is-pulled-right'])];
  
  // setting
  var settings_keys = Object.keys(app.default.indicators[text]);
  if (settings_keys.length === 0) conditions_components.push(bulma_lib.div.make({},['column', 'is-6']))
  settings_keys.forEach(function(label) {
    var json_settings = this.indicators[this.text], json_keys = Object.keys(json_settings);
    var setting_column = bulma_lib.div.make({},['column', ('is-' + (6 / json_keys.length).toString())]);
    setting_column.appendChild(bulma_lib.input.makeWithButton({}, ['is-fullwidth'], label, json_settings[label]));
    this.conditions_components.push(setting_column);
  }, {conditions_components: conditions_components, text: text, indicators: app.default.indicators})
  
  //timeframes
  conditions_components.push(bulma_lib.select.make(app.default.timeframes, 'is-2', 1, 'tf'))
  
  //delete_button
  var del_col = bulma_lib.div.make({},['column', 'is-1'])
  var del_el = bulma_lib.button.make(null,'far fa-trash-alt', {onclick: 'deleteIndicatorForm(this)'},[]);
  del_col.appendChild(del_el)
  conditions_components.push(del_col)

  return bulma_lib.horizontalForm.make(conditions_components, 'is-10', {'onchange': 'indicatorActions()'}, ['is-desktop','is-vcentered']);
}

///END INDICATOR FORM///

  
  function appendIndicatorForm(input) {
    console.log(input)
    bulma_lib.button.unfocus(input);
    var indicator_form = newIndicatorForm(input.getAttribute("value"));
    bulma_lib.appendElement('indicators', indicator_form);
  };
  
  function indicatorActions() {

    var settings = Array.prototype.slice.call(document.getElementById('indicators').querySelectorAll('div[name="IndicatorForm"]')).map(function(node) {
      var indicator = Array.prototype.slice.call(node.querySelectorAll('label'),0).map(function(a) { return a.outerText})
      var keys = Array.prototype.slice.call(node.querySelectorAll('a'),0).map(function(a) { return a.outerText})
      var values = Array.prototype.slice.call(node.querySelectorAll('input'),0).map(function(a) { return a.value || a.placeholder })
      var timeframe = bulma_lib.select.getSelected(node.querySelectorAll("option"))[0].value
      return {indicator: indicator, keys: keys, values: values, timeframe: timeframe};
    })
    
    function onlyUnique(value, index, self) {
      return (self.indexOf(value) === index && value !== 'Timeframe');
    }

    app.user.timeframes = app.default.timeframes.filter(function(tf) {
      return this.unique.indexOf(tf) > -1;
    }, {unique: settings.map(function(tf) { return tf.timeframe; }).filter(onlyUnique)});
    
    app.user.indicators = settings.map(function(s) {return s.indicator + '(' + s.values.join(',') + ').' + s.timeframe});
  }
  
  function newConditionForm(options,action) {
  
    var ohlcv = app.user.timeframes.map(function(tf) {
      return ['open', 'close', 'high', 'low', 'volume'].map(function(el) {
        return 'OHLCV(' + el + ').' + tf;
      });
    }).flat();
    var all_indicators = app.user.indicators.concat(ohlcv);

    var indicators_left =  bulma_lib.select.make(all_indicators, 'is-2', 1, 'Indicators');
    var operator = bulma_lib.buttonsList.make(['<','=','>'], null, 'is-2', null, ['is-centered']);
    var indicators_right =  bulma_lib.select.make(all_indicators, 'is-2', 1, 'Indicators');
    var delete_button = bulma_lib.button.make(null,'far fa-trash-alt', {onclick: 'deleteIndicatorForm(this)'});

    var form_components = [indicators_left,operator,indicators_right,delete_button]

    return bulma_lib.horizontalForm.make('is-10', form_components, {'onchange': action}, ['is-desktop','is-vcentered']);
  }
    
  function appendConditionForm() {
    bulma_lib.appendElement('conditions', newConditionForm());
  }
  
  
  
  function deleteIndicatorForm(e) {
    e.parentNode.parentNode.parentNode.remove();
  }
</script>