<script>

  var _ = _u;

  app = {};
  
  app.user = {
    timeframes: [],
    indicators: [],
    conditions: [],
    actions: [],
    indicatorsSlug: []
  }
  
  app.default = {
    timeframes: ['15m','30m','1h','2h','4h','1d','7d'],
    indicators: {
      BOLL: {periods: 20,sdn: 2},
      CCI: {periods: 26},
      DMA: {fast: 10,slow: 50},
      DMI: {periods: 14},
      SMA: {periods: 30},
      EMA: {periods: 30},
      MACD: {fast: 12,slow: 26,signal: 9},
      MTM: {periods: 9},
      ROC: {periods: 12},
      RSI: {periods: 14},
      TRIX: {periods: 12}
    }
  }
   
  window.onload = function() {

  };
 
 
function toggleIndicatorsList() {
  
  var icon = document.getElementById('plus-minus-indicators');
  bulma_lib.icon.toggle(icon, 'fa-minus', 'fa-plus');
    
  var target = document.getElementById('indicators-list');
  if (target.hasChildNodes()) {
    
    while (target.firstChild) {
      target.removeChild(target.firstChild);
    }

  } else {
    var keys = Object.keys(app.default.indicators);
    var button_attributes = {type: 'submit',onclick: 'indicatorListActions(this.value)'};
    var el = bulma_lib.buttonsList.make({}, ['is-right'], keys, [], button_attributes, ['is-narrow'])
    target.appendChild(el);
  }
};


function fieldControl(el, field_classes, control_classes) {
  control_classes = ['control'].concat(control_classes ||[]);
  field_classes = ['field'].concat(field_classes ||[]);
  var el_control =  bulma_lib.element.make('div', {}, control_classes).childs(el).element
  return bulma_lib.element.make('div', {}, field_classes).childs(el_control).element
}
  
function newIndicatorForm(text) {
  
  // label
  var l = bulma_lib.element.make('label', {}, ['label'], text).element
  var label = bulma_lib.element.make('div', {name: 'indicatorName'}, ['field-label', 'is-normal']).element
  label.appendChild(l);
  
  var form_attibutes = {
    name: 'indicatorForm',
    onchange: 'indicatorFormActions()'
  }
  var form = bulma_lib.element.make('div', form_attibutes, ['field', 'is-horizontal']).element;
  form.appendChild(label)

  var field_body = bulma_lib.element.make('div', {}, ['field-body']).element
  
  // setting 
  Object.keys(app.default.indicators[text]).map(function(label, index, self) {
    
    var button = bulma_lib.element.make('button', {}, ['button', 'is-static'], label).element;
    var input = bulma_lib.element.make('input', {type: 'text', placeholder: (label,this.indicators[this.text][label])}, ['input', 'is-fullwidth'], label).element;
    var button_input = bulma_lib.addon(button, input, null, ['is-expanded']);
    var field = bulma_lib.element.make('div', {}, ['field']).element
    field.appendChild(button_input)
    this.field_body.appendChild(field)
    
    if ((self.length === index+1) && self.length < 3) {
      var i = self.length;
      while (i < 3) {
        var input = bulma_lib.element.make('input', {type: 'text', disabled: true}, ['input', 'is-fullwidth']).element;
        var field = bulma_lib.element.make('div', {}, ['field']).element
        field.appendChild(fieldControl(input))
        this.field_body.appendChild(field)
        i++;
      }
    }
  }, {text: text, indicators: app.default.indicators, field_body: field_body})
  
  // timeframes
  var tf = fieldControl(bulma_lib.select.make({size: 1}, [], ['timeframe'].concat(app.default.timeframes)));
  field_body.appendChild(tf)
  
  // delete_button
  var button_attributes = {
    onclick: 'deleteIndicatorActions(this)'
  }
  var delete_button = bulma_lib.button.make(button_attributes, [],null,'far fa-trash-alt');
  field_body.appendChild(delete_button)
  
  form.appendChild(field_body)
  return form;
};

  function newConditionForm(options, action) {
  
    var ohlcv = app.user.timeframes.map(function(tf) {
      return ['open', 'close', 'high', 'low', 'volume'].map(function(el) {
        return 'OHLCV(' + el + ').' + tf;
      });
    }).flat();
    var all_indicators = app.user.indicators.concat(ohlcv);

    var indicators_left =  bulma_lib.select.make(all_indicators, null, 1, 'Indicators');
    
    var operator_col = bulma_lib.div.make({},['column']);
    operator_col.appendChild(bulma_lib.buttonsList.make(['<','=','>'], null, null, null, ['is-centered']))
    var indicators_right =  bulma_lib.select.make(all_indicators, null, 1, 'Indicators');
    var delete_button = bulma_lib.button.make(null,'far fa-trash-alt', {onclick: 'deleteIndicatorForm(this)'});

    var form_components = [
      indicators_left,
      operator_col,
      indicators_right,
      delete_button
    ]
   
    return bulma_lib.horizontalForm.make(form_components, 'is-12', {'onchange': action}, ['is-desktop','is-vcentered']);
  }
  
function appendIndicatorForm(input) {

  var indicator_form = newIndicatorForm(input);
  bulma_lib.appendElement('indicators-forms', indicator_form);
};
    
function appendConditionForm() {

  var condition_form = newConditionForm();
  bulma_lib.appendElement('conditions-forms', condition_form);
}


  
function getUserIndicators() {
  return Array.prototype.slice.call(document.getElementById('indicators-forms')
  .querySelectorAll('div[name=indicatorForm]')).map(function(node) {
    
    return {
      name: node.querySelector('div[name="indicatorName"]').firstChild.innerText,
      keys: Array.prototype.slice.call(node.querySelectorAll('button.button.is-static')).map(function(el) {
        return el.outerText;
      }),
      values: Array.prototype.slice.call(node.querySelectorAll('input'))
        .filter(function(el) { return !el.disabled})
        .map(function(el) {return el.value || el.placeholder;}),
      timeframe: node.querySelector('select').selectedOptions[0].value,
    }
  });
};
  
function getUserTimeframes(user_indicators) {

  function onlyUnique(value, index, self) { 
    return self.indexOf(value) === index;
  }

  return _.compact(user_indicators.map(function(e) {return e.timeframe}).filter(onlyUnique));
};

function getUserIndicatorsSlug(user_indicators) {

  return user_indicators
  .filter(function(s) {
    return s.timeframe
  })
  .map(function(s) {
    return s.name
    + '(' + s.values.join(',') + ').'
    + s.timeframe
  })
};

function updateUserApp() {

  var user_indicators = getUserIndicators();
  app.user.indicators = user_indicators;
  console.log(app.user.indicators)
  app.user.timeframes = getUserTimeframes(user_indicators);
  console.log(app.user.timeframes)
  app.user.indicatorsSlug = getUserIndicatorsSlug(user_indicators);
  console.log(app.user.indicatorsSlug)
}

// MAIN ACTIONS
function indicatorListActions(input) {

  appendIndicatorForm(input);
  updateUserApp();
}

function deleteIndicatorActions(input) {

  input.parentNode.parentNode.parentNode.remove();
  updateUserApp();
  //updateConditionsDropdowns();
}

function indicatorFormActions() {

  updateUserApp();
  //updateConditionsDropdowns();
}
// END MAIN ACTIONS

</script>